<!-- Always Visible Sidebar -->
<nav class="sidebar">
    <button class="nav-btn" [class.active]="activeTab() === 'relations'" (click)="selectTab('relations')"
        [title]="languageService.dictionary().TOOLTIPS.RELATIONS">
        <lucide-icon [img]="icons.branch" [size]="20"></lucide-icon>
    </button>

    <button class="nav-btn" [class.active]="activeTab() === 'projects'" (click)="selectTab('projects')"
        title="Mis Proyectos">
        <lucide-icon [img]="icons.folder" [size]="20"></lucide-icon>
    </button>

    <button class="nav-btn" [class.active]="activeTab() === 'templates'" (click)="selectTab('templates')"
        [title]="languageService.dictionary().TOOLTIPS.GALLERY">
        <lucide-icon [img]="icons.template" [size]="20"></lucide-icon>
    </button>
    <div style="flex-grow: 1;"></div>
    <button class="nav-btn" [class.active]="activeTab() === 'settings'" (click)="selectTab('settings')"
        [title]="languageService.dictionary().TOOLTIPS.SETTINGS">
        <lucide-icon [img]="icons.settings" [size]="20"></lucide-icon>
    </button>
</nav>

<!-- Sliding Content Drawer -->
<div class="drawer" [class.closed]="!isOpen()">
    <div class="drawer-content">
        <header class="panel-header">
            <h2 [ngSwitch]="activeTab()">
                <span *ngSwitchCase="'relations'">{{ languageService.dictionary().TITLES.RELATIONS }}</span>
                <span *ngSwitchCase="'templates'">{{ languageService.dictionary().TITLES.GALLERY }}</span>
                <span *ngSwitchCase="'settings'">{{ languageService.dictionary().TITLES.SETTINGS }}</span>
                <span *ngSwitchCase="'projects'">Mis Proyectos</span>
            </h2>
        </header>

        <!-- Projects View -->
        <section class="panel-section" *ngIf="activeTab() === 'projects'">
            <div class="templates-list">
                <div class="template-card" *ngFor="let p of userProjects" [class.selected]="p.id === activeProjectId"
                    (click)="projectSelect.emit(p)">
                    <div class="card-icon">
                        <lucide-icon [img]="icons.folder" [size]="24"></lucide-icon>
                    </div>
                    <div class="card-content">
                        <h4>{{ p.name }}</h4>
                        <p style="font-size: 0.8rem; opacity: 0.7;">Click para cargar</p>
                    </div>
                </div>
                <div *ngIf="userProjects.length === 0" class="empty-state">
                    No tienes proyectos guardados a√∫n.
                </div>
            </div>
        </section>

        <!-- Templates View -->
        <section class="panel-section" *ngIf="activeTab() === 'templates'">
            <div class="templates-list">
                <div class="template-card" *ngFor="let t of templates()" (click)="onTemplateSelect(t)" draggable="true"
                    (dragstart)="onDragStart($event, t)">
                    <div class="card-icon">
                        <lucide-icon [img]="t.category === 'Database' ? icons.save : icons.branch"
                            [size]="24"></lucide-icon>
                    </div>
                    <div class="card-content">
                        <h4>{{ t.name }}</h4>
                        <p>{{ t.description }}</p>
                    </div>
                </div>
            </div>

            <!-- Hidden Drag Preview -->
            <div id="drag-preview" class="node-preview">
                <div class="preview-header">
                    <div class="preview-icon"></div>
                </div>
                <div class="preview-body"></div>
            </div>
        </section>

        <!-- Relations View -->
        <section class="panel-section" *ngIf="activeTab() === 'relations'">
            <h3>{{ languageService.dictionary().TITLES.RELATIONS }}</h3>

            <div class="create-box">
                <div class="form-group">
                    <label>{{ languageService.dictionary().RELATIONS.SOURCE }}</label>
                    <select [ngModel]="newConnSourceId()" (ngModelChange)="newConnSourceId.set($event)">
                        <option value="" disabled selected>{{ languageService.dictionary().RELATIONS.SELECT }}</option>
                        <option *ngFor="let node of sources" [value]="node.id">{{ node.label }}</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>{{ languageService.dictionary().RELATIONS.TARGET }}</label>
                    <select [ngModel]="newConnTargetId()" (ngModelChange)="newConnTargetId.set($event)"
                        [disabled]="!newConnSourceId()">
                        <option value="" disabled selected>{{ languageService.dictionary().RELATIONS.SELECT }}</option>
                        <option *ngFor="let node of targets" [value]="node.id">{{ node.label }}</option>
                    </select>
                </div>

                <button class="btn-primary" (click)="create()" [disabled]="!newConnSourceId() || !newConnTargetId()">
                    <lucide-icon [img]="icons.plus" [size]="16"></lucide-icon>
                    {{ languageService.dictionary().RELATIONS.CREATE_BTN }}
                </button>
            </div>

            <div class="connections-list">
                <div class="connection-item" *ngFor="let conn of connections"
                    [class.selected]="conn.id === selectedConnectionId" (click)="connectionSelect.emit(conn.id)">
                    <div class="conn-info">
                        <span class="node-badge source">{{ getNodeLabel(conn.sourceNodeId) }}</span>
                        <lucide-icon [img]="icons.arrowRight" [size]="14" class="arrow-icon"></lucide-icon>
                        <span class="node-badge" [ngClass]="getConnectionClass(conn)">{{
                            getNodeLabel(conn.targetNodeId)
                            }}</span>
                    </div>

                    <div class="conn-actions">
                        <input #nameInput type="text"
                            [placeholder]="languageService.dictionary().RELATIONS.NAME_PLACEHOLDER"
                            [ngModel]="conn.name" (blur)="updateName(conn, nameInput.value)" class="name-input">
                        <button class="btn-icon delete" (click)="deleteConn(conn.id)"
                            [title]="languageService.dictionary().TOOLTIPS.DELETE">
                            <lucide-icon [img]="icons.trash" [size]="16"></lucide-icon>
                        </button>
                    </div>
                </div>

                <div *ngIf="connections.length === 0" class="empty-state">
                    {{ languageService.dictionary().RELATIONS.EMPTY_STATE }}
                </div>
            </div>
        </section>

        <!-- Settings View (Placeholder) -->
        <section class="panel-section" *ngIf="activeTab() === 'settings'">
            <div class="form-group">
                <label>{{ languageService.dictionary().SETTINGS.LANGUAGE }}</label>
                <select [ngModel]="languageService.currentLang()" (ngModelChange)="languageService.setLanguage($event)">
                    <option *ngFor="let lang of languageService.availableLanguages" [value]="lang.code">
                        {{ lang.label }}
                    </option>
                </select>
            </div>

            <div class="empty-state">
                <lucide-icon [img]="icons.settings" [size]="48"
                    style="opacity: 0.2; margin-bottom: 1rem;"></lucide-icon>
                <p>{{ languageService.dictionary().SETTINGS.SOON }}</p>
                <small>{{ languageService.dictionary().SETTINGS.SOON_DESC }}</small>
            </div>
        </section>
    </div>

    <!-- Move toggle button to be attached to drawer -->
    <button class="toggle-btn" (click)="toggle()">
        <lucide-icon [img]="isOpen() ? icons.chevronLeft : icons.chevronRight" [size]="20"></lucide-icon>
    </button>
</div>

<!-- Confirmation Dialog -->
<app-confirm-dialog [visible]="dialogVisible" [title]="languageService.dictionary().DIALOGS.DELETE_RELATION_TITLE"
    [message]="languageService.dictionary().DIALOGS.DELETE_RELATION_MSG"
    [confirmText]="languageService.dictionary().DIALOGS.CONFIRM"
    [cancelText]="languageService.dictionary().DIALOGS.CANCEL" (confirm)="onConfirmDelete()"
    (cancel)="onCancelDelete()">
</app-confirm-dialog>