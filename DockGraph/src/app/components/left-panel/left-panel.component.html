<!-- Always Visible Sidebar -->
<nav class="sidebar">
    <button class="nav-btn" [class.active]="activeTab() === 'relations'" (click)="selectTab('relations')"
        title="Relaciones">
        <lucide-icon [img]="icons.branch" [size]="20"></lucide-icon>
    </button>
    <button class="nav-btn" [class.active]="activeTab() === 'settings'" (click)="selectTab('settings')"
        title="Configuración">
        <lucide-icon [img]="icons.settings" [size]="20"></lucide-icon>
    </button>
</nav>

<!-- Sliding Content Drawer -->
<div class="drawer" [class.closed]="!isOpen()">
    <div class="drawer-content">
        <header class="panel-header">
            <h2>{{ activeTab() === 'relations' ? 'Administración' : 'Configuración' }}</h2>
        </header>

        <!-- Relations View -->
        <section class="panel-section" *ngIf="activeTab() === 'relations'">
            <h3>Relaciones</h3>

            <div class="create-box">
                <div class="form-group">
                    <label>Origen (Servicio)</label>
                    <select [ngModel]="newConnSourceId()" (ngModelChange)="newConnSourceId.set($event)">
                        <option value="" disabled selected>Seleccionar...</option>
                        <option *ngFor="let node of sources" [value]="node.id">{{ node.label }}</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Destino</label>
                    <select [ngModel]="newConnTargetId()" (ngModelChange)="newConnTargetId.set($event)"
                        [disabled]="!newConnSourceId()">
                        <option value="" disabled selected>Seleccionar...</option>
                        <option *ngFor="let node of targets" [value]="node.id">{{ node.label }}</option>
                    </select>
                </div>

                <button class="btn-primary" (click)="create()" [disabled]="!newConnSourceId() || !newConnTargetId()">
                    <lucide-icon [img]="icons.plus" [size]="16"></lucide-icon>
                    Crear Relación
                </button>
            </div>

            <div class="connections-list">
                <div class="connection-item" *ngFor="let conn of connections"
                    [class.selected]="conn.id === selectedConnectionId" (click)="connectionSelect.emit(conn.id)">
                    <div class="conn-info">
                        <span class="node-badge source">{{ getNodeLabel(conn.sourceNodeId) }}</span>
                        <lucide-icon [img]="icons.arrowRight" [size]="14" class="arrow-icon"></lucide-icon>
                        <span class="node-badge" [ngClass]="getConnectionClass(conn)">{{
                            getNodeLabel(conn.targetNodeId)
                            }}</span>
                    </div>

                    <div class="conn-actions">
                        <input #nameInput type="text" placeholder="Nombre de referencia..." [ngModel]="conn.name"
                            (blur)="updateName(conn, nameInput.value)" class="name-input">
                        <button class="btn-icon delete" (click)="deleteConn(conn.id)" title="Eliminar">
                            <lucide-icon [img]="icons.trash" [size]="16"></lucide-icon>
                        </button>
                    </div>
                </div>

                <div *ngIf="connections.length === 0" class="empty-state">
                    No hay relaciones creadas
                </div>
            </div>
        </section>

        <!-- Settings View (Placeholder) -->
        <section class="panel-section" *ngIf="activeTab() === 'settings'">
            <div class="empty-state">
                <lucide-icon [img]="icons.settings" [size]="48"
                    style="opacity: 0.2; margin-bottom: 1rem;"></lucide-icon>
                <p>Próximamente</p>
                <small>Más opciones de administración estarán disponibles aquí.</small>
            </div>
        </section>
    </div>

    <!-- Move toggle button to be attached to drawer -->
    <button class="toggle-btn" (click)="toggle()">
        <lucide-icon [img]="isOpen() ? icons.chevronLeft : icons.chevronRight" [size]="20"></lucide-icon>
    </button>
</div>

<!-- Confirmation Dialog -->
<app-confirm-dialog [visible]="dialogVisible" title="Eliminar Relación"
    message="¿Estás seguro de que quieres eliminar esta relación? Esta acción no se puede deshacer."
    confirmText="Eliminar" cancelText="Cancelar" (confirm)="onConfirmDelete()" (cancel)="onCancelDelete()">
</app-confirm-dialog>